# Design <!-- omit in toc -->

## Architectural Overview

<p align="center"><img src="../../assets/design/architecture-overview.excalidraw.png" width="1000px" /></p>

## Components

### Server

The server is a REST server which exposes the API consumed by the Web UI. It has the following responsibilities:
- listener for Git webhook events

Othter functionnalities will be implemented when the Web UI will be developped.

### Repository Controller

The repository controller is a Kubernetes Controller which is only used to resgister `TerraformRepository` ressources.

### Layer Controller

The layer controller is a Kubernetes Controller which continuously monitors declared `TerraformLayer` ressources.
It regurlarly start runner pods which runs a `terraform plan` for each of your layer to check if a drift has been introduced.
If so, it has the possibility to run a `terraform apply`.

It also is responsible for running your terraform `plan` and `apply` if there a new commit on your layer.

It also generates [`Leases`](https://kubernetes.io/docs/concepts/architecture/leases/) to make sure no concurrent terraform commands will be launched on the same layer at the same time.

### Redis

The redis instance is used to store the binary generated by `terraform plan` before running the `apply`.
